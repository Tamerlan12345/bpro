<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>BizMap AI Agent</title>
    <link rel="stylesheet" href="style.css">
    <script src="https://cdn.jsdelivr.net/npm/mermaid@10/dist/mermaid.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/html2canvas@1.4.1/dist/html2canvas.min.js"></script>
</head>
<body>
    <div class="auth-wrapper">
        <header class="app-header">
            <h1><a href="/">BizMap AI</a></h1>
            <p style="color: var(--text-secondary); margin-top: 0.5rem;">–í–∞—à –∏–Ω—Ç–µ–ª–ª–µ–∫—Ç—É–∞–ª—å–Ω—ã–π –±–∏–∑–Ω–µ—Å-–∞—Å—Å–∏—Å—Ç–µ–Ω—Ç</p>
            <button id="logout-btn" class="button-secondary" style="display: none; margin: 1rem auto;">–í—ã–π—Ç–∏</button>
        </header>
        <main>
            <div id="login-container" class="login-container">
                <div id="user-login" class="login-form">
                    <h2>–í—Ö–æ–¥ –≤ —Å–∏—Å—Ç–µ–º—É</h2>
                    <p>–ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –∞–≤—Ç–æ—Ä–∏–∑—É–π—Ç–µ—Å—å –¥–ª—è –ø—Ä–æ–¥–æ–ª–∂–µ–Ω–∏—è —Ä–∞–±–æ—Ç—ã</p>
                    <div class="form-group">
                        <label for="user-name">–ò–º—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è</label>
                        <input type="text" id="user-name" placeholder="–í–≤–µ–¥–∏—Ç–µ –ª–æ–≥–∏–Ω" value="user">
                    </div>
                    <div class="form-group">
                        <label for="user-password">–ü–∞—Ä–æ–ª—å</label>
                        <input type="password" id="user-password" placeholder="–í–≤–µ–¥–∏—Ç–µ –ø–∞—Ä–æ–ª—å" value="userpassword">
                    </div>
                    <button id="user-login-btn" class="button-primary" style="width: 100%;">–í–æ–π—Ç–∏</button>
                    <p id="user-error" class="error-message" style="color: var(--danger-color); text-align: center; margin-top: 1rem; margin-bottom: 0;"></p>
                </div>

                <div id="department-selection" class="login-form" style="display: none; max-width: 800px;">
                    <h2>–í—ã–±–µ—Ä–∏—Ç–µ –¥–µ–ø–∞—Ä—Ç–∞–º–µ–Ω—Ç</h2>
                    <div id="department-selection-container"></div>
                    <p id="department-selection-error" class="error-message"></p>
                </div>

                <div id="chat-login" class="login-form" style="display: none; max-width: 800px;">
                    <div style="display: flex; align-items: center; margin-bottom: 1.5rem;">
                         <button id="back-to-depts-btn" class="button-secondary" style="margin-right: auto;">‚Üê –ù–∞–∑–∞–¥</button>
                         <h2 style="margin: 0; flex: 1; text-align: center;">–í—ã–±–µ—Ä–∏—Ç–µ —á–∞—Ç</h2>
                         <div style="width: 80px;"></div>
                    </div>
                    <div id="chat-selection-container"></div>
                    <div style="border-top: 1px solid var(--border-color); padding-top: 1.5rem; margin-top: 1rem;">
                         <input type="password" id="chat-password" placeholder="–ü–∞—Ä–æ–ª—å —á–∞—Ç–∞" style="max-width: 300px; margin: 0 auto 1rem; display: block;">
                         <button id="chat-login-btn" class="button-primary" style="width: 100%; max-width: 300px; margin: 0 auto; display: flex;">–í–æ–π—Ç–∏ –≤ —á–∞—Ç</button>
                         <p id="chat-error" class="error-message" style="text-align: center; color: var(--danger-color); margin-top: 1rem;"></p>
                    </div>
                </div>
            </div>

            <div id="admin-panel" style="display: none;">
                <div class="admin-layout">
                    <aside class="admin-sidebar">
                        <div class="admin-brand">BizMap Admin</div>
                        <nav class="admin-nav">
                            <button class="admin-nav-item active" data-target="admin-section-management">–£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ</button>
                            <button class="admin-nav-item" data-target="admin-section-review">–ü—Ä–æ–≤–µ—Ä–∫–∞</button>
                        </nav>
                    </aside>
                    <main class="admin-content">
                        <div id="admin-section-management" class="admin-view-section active">
                            <div style="display: grid; grid-template-columns: 350px 1fr; gap: 2rem;">
                                <div class="admin-column">
                                     <div class="admin-card">
                                        <h4>–ù–æ–≤—ã–π –¥–µ–ø–∞—Ä—Ç–∞–º–µ–Ω—Ç</h4>
                                        <select id="user-for-new-department" style="margin-bottom: 0.5rem;"></select>
                                        <input type="text" id="new-department-name" placeholder="–ù–∞–∑–≤–∞–Ω–∏–µ" style="margin-bottom: 0.5rem;">
                                        <input type="password" id="new-department-password" placeholder="–ü–∞—Ä–æ–ª—å" style="margin-bottom: 0.5rem;">
                                        <button id="create-department-btn" class="button-primary">–°–æ–∑–¥–∞—Ç—å</button>
                                     </div>
                                     <div id="department-list"></div>
                                </div>
                                <div class="admin-column">
                                    <div class="admin-card">
                                        <h3 id="chat-list-header">–ß–∞—Ç—ã</h3>
                                        <div id="create-chat-form" style="display: none; margin-bottom: 1rem;">
                                            <input type="text" id="new-chat-name" placeholder="–ù–∞–∑–≤–∞–Ω–∏–µ" style="margin-bottom: 0.5rem;">
                                            <input type="password" id="new-chat-password" placeholder="–ü–∞—Ä–æ–ª—å" style="margin-bottom: 0.5rem;">
                                            <button id="create-chat-btn" class="button-primary">–°–æ–∑–¥–∞—Ç—å</button>
                                        </div>
                                        <div id="chat-list"></div>
                                    </div>
                                </div>
                            </div>
                        </div>
                        <div id="admin-section-review" class="admin-view-section">
                            <div class="admin-tabs">
                                <button id="in-review-tab" class="tab-link active">–ù–∞ –ø—Ä–æ–≤–µ—Ä–∫–µ</button>
                                <button id="pending-tab" class="tab-link">–í —Ä–∞–±–æ—Ç–µ</button>
                                <button id="completed-tab" class="tab-link">–ó–∞–≤–µ—Ä—à–µ–Ω–Ω—ã–µ</button>
                            </div>
                            <ul id="in-review-list" class="admin-list"></ul>
                            <ul id="pending-list" class="admin-list" style="display:none;"></ul>
                            <ul id="completed-list" class="admin-list" style="display:none;"></ul>
                        </div>
                    </main>
                </div>
            </div>
        </main>
    </div>

    <div class="container" style="display: none;">
        <div class="workspace-layout">
            <header>
                <div class="header-left">
                    <button id="back-to-admin-btn" style="display: none;">‚Üê</button>
                    <h1 id="chat-name-header" class="header-title">BizMap AI</h1>
                </div>
                <div id="action-buttons">
                    <button id="save-version-btn" class="button-primary">–°–æ—Ö—Ä–∞–Ω–∏—Ç—å —Å –ò–ò</button>
                    <button id="save-raw-version-btn" class="button-secondary">–°–æ—Ö—Ä–∞–Ω–∏—Ç—å</button>
                    <button id="send-review-btn" class="button-secondary">–ù–∞ –ø—Ä–æ–≤–µ—Ä–∫—É</button>
                    <button id="send-revision-btn" class="button-danger" style="display: none;">–ù–∞ –¥–æ—Ä–∞–±–æ—Ç–∫—É</button>
                    <button id="complete-btn" class="button-primary" style="display: none;">–ó–∞–≤–µ—Ä—à–∏—Ç—å</button>
                    <button id="archive-btn" class="button-secondary" style="display: none;">–í –∞—Ä—Ö–∏–≤</button>
                </div>
            </header>

            <main class="main-content">
                <div class="left-column">
                    <div class="sidebar-block">
                        <h3>1. –û–ø–∏—Å–∞–Ω–∏–µ</h3>
                        <textarea id="process-description" placeholder="–û–ø–∏—à–∏—Ç–µ –ø—Ä–æ—Ü–µ—Å—Å..." style="min-height: 150px;"></textarea>
                        <div id="step-counter" class="step-counter" style="margin-bottom: 0.5rem;">0 —à–∞–≥–æ–≤</div>
                        <div class="audio-controls" style="display: flex; gap: 0.5rem; flex-wrap: wrap;">
                             <button id="start-record-btn" class="button-primary" style="flex: 1;">üéôÔ∏è –ó–∞–ø–∏—Å—å</button>
                             <button id="stop-record-btn" class="button-danger" style="display: none; flex: 1;">‚èπÔ∏è –°—Ç–æ–ø</button>
                             <button id="process-btn" class="button-primary" style="display: none; flex: 1;">‚ö° –û–±—Ä–∞–±–æ—Ç–∞—Ç—å</button>
                        </div>
                        <span id="recording-timer" style="display:none; color: var(--danger-color); font-weight: bold; margin-top: 0.5rem;">00:00</span>
                    </div>
                </div>
                <div id="left-panel-toggle" class="panel-toggle left-panel-toggle">&lt;&lt;</div>

                <div class="center-column">
                    <div id="diagram-container" class="diagram-container"></div>
                    <div id="diagram-placeholder" class="diagram-placeholder">
                        <div class="placeholder-content">
                            <p>–°—Ö–µ–º–∞ –ø–æ—è–≤–∏—Ç—Å—è –∑–¥–µ—Å—å</p>
                            <button id="render-diagram-btn" class="button-secondary">–°–æ–∑–¥–∞—Ç—å —Å—Ö–µ–º—É</button>
                        </div>
                    </div>

                    <div id="floating-toolbar" class="floating-toolbar" style="display: none;">
                        <button id="zoom-in-btn" title="–ü—Ä–∏–±–ª–∏–∑–∏—Ç—å">+</button>
                        <button id="zoom-out-btn" title="–û—Ç–¥–∞–ª–∏—Ç—å">-</button>
                        <div class="divider"></div>
                        <button id="fit-screen-btn" title="–í–µ—Å—å —ç–∫—Ä–∞–Ω">‚õ∂</button>
                        <button id="download-png-btn" title="–°–∫–∞—á–∞—Ç—å PNG">üì∑</button>
                        <div class="divider"></div>
                         <button class="add-node-btn" data-shape="rect" title="–î–µ–π—Å—Ç–≤–∏–µ">‚¨ú</button>
                        <button class="add-node-btn" data-shape="diamond" title="–£—Å–ª–æ–≤–∏–µ">‚óá</button>
                        <button class="add-node-btn" data-shape="rounded" title="–ù–∞—á–∞–ª–æ/–ö–æ–Ω–µ—Ü">‚óØ</button>
                    </div>

                    <div id="split-view-container" class="split-view-container" style="display: none;">
                        <div class="split-code">
                            <div class="split-toolbar">
                                <span>Mermaid Code</span>
                                <button id="close-split-view-btn" class="button-secondary">–ó–∞–∫—Ä—ã—Ç—å</button>
                            </div>
                            <textarea id="split-view-textarea" spellcheck="false"></textarea>
                            <button id="save-split-view-btn" class="button-primary" style="margin: 1rem;">–ü—Ä–∏–º–µ–Ω–∏—Ç—å</button>
                        </div>
                        <div class="split-preview" id="split-view-preview"></div>
                    </div>
                </div>

                <div class="right-column">
                    <div class="sidebar-block">
                        <h3>–ò—Å—Ç–æ—Ä–∏—è & –ö–æ–º–º–µ–Ω—Ç–∞—Ä–∏–∏</h3>
                        <div id="version-history-container" style="max-height: 150px; overflow-y: auto; margin-bottom: 1rem;"></div>
                        <div id="comments-container" style="max-height: 200px; overflow-y: auto;"></div>
                        <div style="display: flex; gap: 0.5rem; margin-top: 0.5rem;">
                            <input id="comment-input" type="text" placeholder="–ö–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π...">
                            <button id="add-comment-btn" class="button-secondary">OK</button>
                        </div>
                    </div>
                </div>
                <div id="right-panel-toggle" class="panel-toggle right-panel-toggle">&gt;&gt;</div>
            </main>
        </div>
    </div>

    <div id="notification-container" class="notification-container"></div>

    <div id="node-context-menu" class="context-menu" style="display: none;">
        <div class="context-header">–†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ —É–∑–ª–∞</div>
        <div class="context-body">
            <textarea id="node-edit-text" rows="2" placeholder="–¢–µ–∫—Å—Ç —É–∑–ª–∞"></textarea>
            <div class="context-row">
                <label>–§–æ—Ä–º–∞:</label>
                <div class="shape-selector">
                    <button class="shape-btn" data-shape="rect" title="–ü—Ä—è–º–æ—É–≥–æ–ª—å–Ω–∏–∫">‚¨ú</button>
                    <button class="shape-btn" data-shape="rounded" title="–°–∫—Ä—É–≥–ª–µ–Ω–Ω—ã–π">‚óØ</button>
                    <button class="shape-btn" data-shape="diamond" title="–†–æ–º–±">‚óá</button>
                    <button class="shape-btn" data-shape="database" title="–ë–∞–∑–∞">üõ¢</button>
                </div>
            </div>
            <div class="context-row">
                <label>–¶–≤–µ—Ç:</label>
                <div class="color-selector">
                    <button class="color-btn" style="background:#fff; border:1px solid #ccc;" data-color="default"></button>
                    <button class="color-btn" style="background:#bbf7d0;" data-color="green"></button>
                    <button class="color-btn" style="background:#bfdbfe;" data-color="blue"></button>
                    <button class="color-btn" style="background:#fecaca;" data-color="red"></button>
                    <button class="color-btn" style="background:#fef08a;" data-color="yellow"></button>
                </div>
            </div>
            <div class="context-actions">
                <button id="node-delete-btn" class="button-danger-text">–£–¥–∞–ª–∏—Ç—å</button>
            </div>
        </div>
    </div>

    <div id="edge-context-menu" class="context-menu" style="display: none;">
        <div class="context-header">–†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ —Å–≤—è–∑–∏</div>
        <div class="context-body">
            <input type="text" id="edge-edit-text" placeholder="–¢–µ–∫—Å—Ç (–Ω–∞–ø—Ä. –î–∞)">
            <div class="quick-tags">
                <button class="tag-btn" data-text="–î–∞">–î–∞</button>
                <button class="tag-btn" data-text="–ù–µ—Ç">–ù–µ—Ç</button>
                <button class="tag-btn" data-text="">(–û—á–∏—Å—Ç–∏—Ç—å)</button>
            </div>
            <div class="context-row">
                <label>–¢–∏–ø:</label>
                <div class="style-selector">
                    <button class="style-btn" data-style="solid" title="–°–ø–ª–æ—à–Ω–∞—è">‚îÄ‚îÄ‚Üí</button>
                    <button class="style-btn" data-style="dotted" title="–ü—É–Ω–∫—Ç–∏—Ä–Ω–∞—è">- -‚Üí</button>
                    <button class="style-btn" data-style="thick" title="–ñ–∏—Ä–Ω–∞—è">‚ïê‚ïê‚Üí</button>
                </div>
            </div>
            <div class="context-actions">
                <button id="edge-reverse-btn" class="button-secondary-text">üîÑ –†–∞–∑–≤–µ—Ä–Ω—É—Ç—å</button>
                <button id="edge-delete-btn" class="button-danger-text">–£–¥–∞–ª–∏—Ç—å</button>
            </div>
        </div>
    </div>

    <script src="script.js?v=5"></script>
    <script>
        document.addEventListener('DOMContentLoaded', () => {
            const adminNavItems = document.querySelectorAll('.admin-nav-item');
            const adminSections = document.querySelectorAll('.admin-view-section');
            if (adminNavItems) {
                adminNavItems.forEach(item => {
                    item.addEventListener('click', () => {
                        const targetId = item.dataset.target;
                        adminNavItems.forEach(nav => nav.classList.remove('active'));
                        item.classList.add('active');
                        adminSections.forEach(section => {
                            if (section.id === targetId) {
                                section.classList.add('active');
                            } else {
                                section.classList.remove('active');
                            }
                        });
                    });
                });
            }
            const backToDeptsBtn = document.getElementById('back-to-depts-btn');
            if(backToDeptsBtn) {
                backToDeptsBtn.addEventListener('click', () => {
                    document.getElementById('chat-login').style.display = 'none';
                    document.getElementById('department-selection').style.display = 'block';
                });
            }
        });
    </script>
</body>
</html>
